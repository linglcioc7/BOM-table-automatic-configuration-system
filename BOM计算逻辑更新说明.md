# BOM计算逻辑更新说明

## 更新概述

本次更新修改了BOM生成系统的计算逻辑，使配方中组件的子项数量能够正确乘以用户输入的基本数量。

## 更新前的问题

在之前的版本中，BOM表生成时，配方组件的子项数量直接使用配方中定义的数量，没有考虑用户输入的基本数量。例如：
- 配方中组件A的子项数量为0.27
- 用户输入基本数量为100
- 生成的BOM表中，组件A的子项数量仍为0.27（而不是27）

## 更新后的逻辑

现在系统会按照以下规则计算子项数量：

**子项数量计算规则：**
- **KG和M单位**：子项数量 = 配方数量 × 基本数量
- **EA单位**：子项数量 = 配方数量（不乘以基本数量）

### 具体示例

| 配方数量 | 基本数量 | 计算后数量 | 说明 |
|---------|---------|-----------|------|
| 0.27 KG | 100 | 27 KG | 0.27 × 100 = 27（KG单位需要相乘） |
| 2 EA | 100 | 2 EA | 2（EA单位保持原数量，不相乘） |
| 1.5 M | 200 | 300 M | 1.5 × 200 = 300（M单位需要相乘） |

## 修改的文件

### app.py

1. **单个BOM生成函数** (`generate_bom`)
   - 位置：第16列（子项数量）
   - 修改：`item['quantity'] * data['basic_quantity']`

2. **批量BOM生成函数** (`batch_generate_bom_from_table`)
   - 位置：第16列（子项数量）
   - 修改：`item['quantity'] * bom_item['basic_quantity']`

## 修改的代码行

```python
# 修改前
ws.cell(row=row, column=16, value=item['quantity'])  # 子项数量

# 修改后（第一版）
ws.cell(row=row, column=16, value=item['quantity'] * data['basic_quantity'])  # 子项数量 = 配方数量 × 基本数量

# 修改后（第二版 - 按单位区分计算）
# 子项数量计算：只有KG和M单位才乘以基本数量，EA单位保持原数量
if item['unit'] in ['KG', 'M']:
    calculated_quantity = item['quantity'] * data['basic_quantity']
else:
    calculated_quantity = item['quantity']
ws.cell(row=row, column=16, value=calculated_quantity)  # 子项数量
```

## 影响范围

- ✅ 单个BOM生成功能
- ✅ 批量BOM生成功能（表格输入）
- ✅ 所有配方组件的数量计算
- ✅ Excel文件输出格式保持不变

## 验证方法

1. 创建一个配方，包含不同单位的组件：
   - KG单位组件（如0.27 KG）
   - EA单位组件（如2 EA）
   - M单位组件（如1.5 M）
2. 生成BOM表时输入基本数量（如100）
3. 检查生成的Excel文件中：
   - KG和M单位组件：数量 = 配方数量 × 基本数量
   - EA单位组件：数量 = 配方数量（保持不变）

## 注意事项

- 配方中定义的数量仍然保持原值，不会被修改
- EA单位的物料项数量不会随基本数量变化，适用于固定数量的组件（如包装材料、标签等）
- KG和M单位的物料项数量会随基本数量按比例变化，适用于按重量或长度计算的原材料
- 只有生成的BOM表中的数量会进行乘法计算
- 单位保持不变，只计算数量值
- 支持小数数量的精确计算

## 技术细节

- 使用Python的浮点数乘法运算
- 保持原有的数据精度
- 不影响其他字段的显示和计算
- 向后兼容，不影响现有功能

---

**更新日期：** 2025年1月
**更新版本：** BOM生成系统 v2.1
**更新类型：** 功能优化


