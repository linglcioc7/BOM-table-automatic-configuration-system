# BOM计算逻辑更新说明

## 更新概述

本次更新修改了BOM生成系统的计算逻辑，使配方中组件的子项数量能够正确乘以用户输入的基本数量。

## 更新前的问题

在之前的版本中，BOM表生成时，配方组件的子项数量直接使用配方中定义的数量，没有考虑用户输入的基本数量。例如：
- 配方中组件A的子项数量为0.27
- 用户输入基本数量为100
- 生成的BOM表中，组件A的子项数量仍为0.27（而不是27）

## 更新后的逻辑

现在系统会按照以下公式计算子项数量：

**子项数量 = 配方数量 × 基本数量**

### 具体示例

| 配方数量 | 基本数量 | 计算后数量 | 说明 |
|---------|---------|-----------|------|
| 0.27 KG | 100 | 27 KG | 0.27 × 100 = 27 |
| 1.5 PCS | 200 | 300 PCS | 1.5 × 200 = 300 |
| 0.05 L | 500 | 25 L | 0.05 × 500 = 25 |

## 修改的文件

### app.py

1. **单个BOM生成函数** (`generate_bom`)
   - 位置：第16列（子项数量）
   - 修改：`item['quantity'] * data['basic_quantity']`

2. **批量BOM生成函数** (`batch_generate_bom_from_table`)
   - 位置：第16列（子项数量）
   - 修改：`item['quantity'] * bom_item['basic_quantity']`

## 修改的代码行

```python
# 修改前
ws.cell(row=row, column=16, value=item['quantity'])  # 子项数量

# 修改后
ws.cell(row=row, column=16, value=item['quantity'] * data['basic_quantity'])  # 子项数量 = 配方数量 × 基本数量
```

## 影响范围

- ✅ 单个BOM生成功能
- ✅ 批量BOM生成功能（表格输入）
- ✅ 所有配方组件的数量计算
- ✅ Excel文件输出格式保持不变

## 验证方法

1. 创建一个配方，包含数量为小数的组件（如0.27）
2. 生成BOM表时输入基本数量（如100）
3. 检查生成的Excel文件中，该组件的数量是否为27（0.27 × 100）

## 注意事项

- 配方中定义的数量仍然保持原值，不会被修改
- 只有生成的BOM表中的数量会进行乘法计算
- 单位保持不变，只计算数量值
- 支持小数数量的精确计算

## 技术细节

- 使用Python的浮点数乘法运算
- 保持原有的数据精度
- 不影响其他字段的显示和计算
- 向后兼容，不影响现有功能

---

**更新日期：** 2025年1月
**更新版本：** BOM生成系统 v2.1
**更新类型：** 功能优化

